# 第15　固有のシーケンス番号生成方法

### 1. 自動インクリメント列

自動インクリメント（auto_increment）はMySQL準拠のほとんどのRDBMS列のプロパティであり、プロパティを設定すると、データベースがその列の値に自動的に値を付与します。テーブル内にレコードが追加されると、ユーザーがその列に値を付与しなくても、その列の値は自動的に大きくなり、一意性を確保します。ほとんどの場合、自動インクリメント列は業務上の意味を持たない代理主キーとして使用されます。自動インクリメント列には、整数型フィールドしか使用できず、割り当てられる値も整数型でなければならないという制約があります。業務に必要なシーケンス番号がアルファベット、数字などの文字で構成されていると仮定すると、ユーザーが自動インクリメント列によってシーケンス番号の必要な数字の自動インクリメント値を取得することは困難です。

### 2. シーケンス（Sequence）

シーケンスはデータベースオブジェクトです。アプリケーションプログラムは特定のシーケンスをコールすることで、シーケンス値をインクリメントできます。アプリケーションプログラムはこのシーケンス値を柔軟に使用して1つか複数のテーブルに値を付与するほか、シーケンス値を使用してより複雑な加工を行い、テキストと数字の結合を実現し、代理キーに一定の追跡と分類上の意味を付与することもできます。TiDB v4.0からシーケンス機能を提供しています。詳細は公式 [ドキュメント](https://docs.pingcap.com/tidb/stable/sql-statement-create-sequence#create-sequence) を参照してください。

### 3. Snowflake型方法
SnowflakeはTwitterが公開していた分散型ID生成方法です。現在実装されているのにはさまざまな種類がありますが、よく知られているのがBaiduのuid-generatorとMeituanのleafです。以下はuid-generatorを例に説明します。

uid-generatorで生成される64桁のIDは次のような構造です。

| sign | delta seconds | worker node id | sequencs |
|------|---------------|----------------|----------|
| 1bit |     28bits    | 22bits         | 13bits   |

- **sign**: 長さは1桁で一定。0で一定。これは生成されるIDが常に正数であるということです。
- **delta seconds**: デフォルトで28桁。現在時刻はプリセットされた時刻基準点（デフォルトで「2016-05-20」）からの増分値（単位秒）です。28桁で最長約8.7年に対応します。
- **worker node id**: デフォルトで22桁。端末ＩＤを示します。通常、アプリケーションプログラム起動時に1つの集中型IDジェネレータから取得されます。よく知られる集中型IDジェネレータには、データベース自動インクリメント列やZookeeperがあります。1回限りの使用がデフォルト設定で、再起動時に新しいworker node idを取得し直します。22桁で最大約420万回の起動に対応します。
- **sequence**: デフォルトで13桁。1秒当たりの同時実行シーケンスを示します。13桁で1秒当たり8192の同時実行に対応します。

Snowflake型方法使用時には、次のいくつかの点に注意する必要があります。

- delta secondsは完全にローカルに生成されるため、端末のクロックに大きく依存します。クロックのコールバックが発生すると、コマンドが重複したり、サービスが使用不可能になったりすることがあります。
- データ想定寿命に基づいてdelta secondsのビット数を変更できます。通常は28桁から44桁とされます。
- delta seconds時刻基準点はデフォルト値を使用せず、可能な限りその時点の時刻に近づける必要があります。
- worker node idのビット数は500万までと制限されています。TiDBの自動インクリメント列を使用してworker node idを実現する場合、TiDBインスタンスを再起動するごとに自動インクリメント列戻り値が3万以上追加されます。このとき、最大5,000,000/30,000=166回インスタンスを再起動すると、自動インクリメント列戻り値がworker node idが許容する最大値より大きくなります。このとき、その最大値より大きい値は使用できず、自動インクリメント列があるテーブルを空にし、自動インクリメント列値をゼロにリセットすることでも、Snowflake実現レイヤーでこの問題を解消できます。

### 4. 数値フィールド設定方法

数字フィールド設定方法は、データベースから自動インクリメントIDをバッチで取得すると理解されます。この方法では、レコードの各行にシーケンスオブジェクトが示されたシーケンス番号生成テーブルが1つ必要となります。テーブル定義の例:

| フィールド名 | フィールド型 | フィールド説明                                         |
|--------------|--------------|--------------------------------------------------------|
| SEQ_NAME     | varchar(128) | シーケンス名は業務を区別するためのもの                 |
| max_ID       | bigint(20)   | その時点でシーケンスに設定されている最大値             |
| STEP         | int(11)      | ステップ長さ。各回で設定された数字フィールド長さを示す |

アプリケーションプログラムは毎回、設定されたステップ長さに応じてシーケンス番号を取得するとともに、その時点でシーケンスに設定されている最大値を永続化するためデータベースを更新して、アプリケーションプログラムメモリでシーケンス番号の加工と設定操作を完了します。1つの番号セグメントが使用され尽くさない限り、アプリケーションプログラムは新しい数字フィールドを取得しようとはしません。これにより、データベースの書き込みストレスを効果的に軽減しています。実際の使用プロセスでは、ステップ長さを適宜調整することで、データベースレコードの更新頻度を制御できます。

最後に注意すべきは、上記2つの方法で生成されたIDは十分にランダムではなく、そのままTiDBテーブルの主キーとするのには適していないということです。実際の使用プロセスでは、生成されたIDに対してビット反転（bit-reverse）を行ってランダムな新IDを得ます。
第2　オブジェクト命名規則
データベース（DATABASE）、テーブル（TABLE）、インデックス（INDEX）、ユーザー（USER）などのデータベースオブジェクトの命名を制約します。
