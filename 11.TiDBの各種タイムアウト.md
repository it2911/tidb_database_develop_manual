# 第11　TiDBの各種タイムアウト

### 1. GCタイムアウト
TiDBのトランザクションの実現にはMVCC（多版型同時実行制御）メカニズムを採用しています。新たに書き込まれたデータによって古いデータが更新されても、古いデータは置換されず、新しいデータとともに保存され、バージョンを区別するためのタイムスタンプが付与されます。TiDBは定期的GCのメカニズムによって不要な古いデータを整理します。

デフォルト設定では、TiDBはMVCCバージョン（キャッシュコヒーレンシ）を10分間保存し、読み取り時間が10分を超えるトランザクションについては、*GC life time is shorter than transaction duration*エラー報告を受信します。

ユーザーがより長い読み取り時間が必要であると判断した場合、例えば、Mydumperをフルバックアップに使用するときは（Mydumperによるバックアップはキャッシュコヒーレンシ）、TiDBのmysql.tidbテーブルの**tikv_gc_life_time**の値を変更することで、MVCCバージョン保存時間をより長くできます。ただし、**tikv_gc_life_time**の設定はグローバルに即座に影響が及ぶため、これを大きくすると、その時点で存在する全キャッシュのライフタイムが長く、小さくすると直ちに全キャッシュのライフタイムが短くなります。MVCCバージョンがあまりに大きいとTiKVの処理効率が低下するため、Mydumperをフルバックアップに使用した後は、**tikv_gc_life_time**をすみやかに元の設定に戻す必要があります。

GCの詳細については、公式ウェブサイトの [ドキュメント](https://docs.pingcap.com/tidb/v4.0/garbage-collection-overview) を参照してください。

### 2. トランザクションタイムアウト
   
DML句を含むトランザクションは、**tikv_gc_life_time**の制限のほか、もう1つのパラメータ**max-txn-time-use**の影響を受けます。このパラメータは、tidb-serverの設定ファイルtidb.tomlで、単一トランザクションが許容する最大実行時間を制御するのに使用されます。このパラメータのデフォルト値は590（秒）です。このパラメータの値は**tikv_gc_life_time**の値未満である必要があります。

`INSERT INTO t10 SELECT * FROM t1`などの型のSQL句は、実行時間が**tikv_gc_life_time**の制限に達していなくても、**max-txn-time-use**の制限を超えると、タイムアウトによりロールバックします。

### 3. SQLタイムアウト

また、TiDBはシステム変数によって1つのSQL句の実行時間: **max_execution_time**を制限します。デフォルト値は0で、これは制限がないことを示します。**max_execution_time**は現在、SELECT句だけでなく、あらゆる型のstatementに有効です。単位はmsですが、実際の精度はより正確なミリ秒レベルではなく100msレベルです。