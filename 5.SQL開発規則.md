# 第5　SQL開発規則

### 1. テーブル作成・削除規則
1. 基本原則:
   テーブルの作成はテーブル命名規則に従いつつ、業務アプリケーション内にテーブル作成・削除句追加判定ロジックをカプセル化し、業務プロセス異常による中断を防止することを推奨します。
2. 詳細な説明:
   `create table if not exists table_name`や`drop table if exists table_name` 句にように、if判定を追加することでアプリケーション側のテーブルの変更による異常な中断を回避します。

### 2. `SELECT *` 使用規則
1. 基本原則:
`SELECT *` を使用してテーブルフルスキャンを実行することは推奨されてません。
2. 詳細な説明:
必要に応じて適切なフィールド列を選択し、全フィールドの`SELECT *`による読み取りを排除し、ネットワーク帯域幅の消費を抑え、カバリングインデックスを効率的に使用します。

### 3. 大規模トランザクション処理
1. 基本原則:
必要に応じて適切なフィールド列を選択し、全フィールドの`SELECT *`による読み取りを排除し、ネットワーク帯域幅の消費を抑え、カバリングインデックスを効率的に使用します。大規模トランザクションを回避するため、TiDBは単一トランザクション量を制限します。このレイヤー制限がKVレベルで、SQLレベルに反映されると、簡単に言えば、データ1行について1つのKV entryがマッピングされ、インデックスが1つ追加されるごとに、KV entryも1つ増加することとなります。このため、この制限はSQLレベルで次のように反映されます。

- 1行最大レコード容量が120MB（TiDB v5.0以降のバージョンはtidb-server設定項目performance.txn-entry-size-limitで調整可能。TiDB v5.0以前のバージョンの1行レコード容量は6MB）。
- サポートする最大単一トランザクション1行最大レコード容量が10GB（TiDB v4.0以降のバージョンはtidb-server設定項目performance.txn-total-size-limitで調整可能。TiDB v4.0以前のバージョンの1行レコード容量は100MB）。
  
また、量制限であるか行数制限であるかにかかわらず、使用時に最適なパフォーマンスを得るため、TiDBのコード作成とトランザクション追加Keyオーバーヘッドを考慮し、100～500行ごとに1つのトランザクションを書き込むことを推奨します。

### 4. フィールドでの関数使用規則
1. 基本原則:
抽出フィールドでは関連関数を使用できます。ただし、Where条件のフィルター条件フィールドでは、データ型変換関数を含む関数を使用することは推奨されません。
2. 詳細な説明:
- 推奨しない記述:
```
SELECT gmt_create FROM ...
WHERE date_format(gmt_create，'%Y%m%d %H:%i:%s') = '20090101 00:00:0'
```
- 推奨する記述:
```
SELECT date_format(gmt_create，'%Y%m%d %H:%i:%s') FROM .. .
WHERE gmt_create = str_to_date('20090101 00:00:00'，'%Y%m%d %H:%i:s')；
```
### 5. データ削除規則
1. 基本原則:
テーブルの全データの削除時には、DELETEではなくTRUNCATEかDROPを使用した後に再構成します。
2. 詳細な説明:
DELETE、TRUNCATE、DROPはすぐにはスペースを解放しません。TRUNCATE、DROP操作に対しては、TiDBのGC（garbage collection）時間到達後（デフォルト10分）、TiDBのGCメカニズムがデータを削除し、スペースを開放します。DELETE操作に対しては、TiDBのGCメカニズムがデータを削除しますが、スペースを開放するのではなく、後続データがRocksDBに書き込まれ、かつ、compact実行時にスペースを再利用します。

### 6. その他の規則
1. **Where**条件では、インデックス列で算術計算か関数計算を行いません。
2. **or**を**in() /union**に置き換えます。また、**in**で指定する項目を300以下に設定することを推奨します。
3. **%** プレフィックスを使用して近似プレフィックスクエリを行うことは禁止されています。
4. アプリケーションがMulti Statementsを使用してSQLを実行する場合、複数のSQL使用セミコロンを結合して一度にクライアントサイドに送信し、TiDBは最初のSQLの実行結果のみを戻します。